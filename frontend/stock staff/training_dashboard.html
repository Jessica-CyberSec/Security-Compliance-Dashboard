<!DOCTYPE html>
<html lang="en">
  <!-- ‚ë† Tiny per‚Äëpage CONFIG (top of file, before anything else uses it) -->
  <script>
    (function () {
      // Compute a base URL for assets/links that works from nested folders (e.g., frontend/cashier/)
      const assetBase = location.origin + location.pathname.replace(/\/[^\/]*$/, "/");

      // Put any page-specific constants here
      window.CONFIG = {
        // SheetDB API endpoint (change ONCE here per page)
        SHEETDB_API: "https://sheetdb.io/api/v1/avv2xl4lw5vfy",
        // Where to resolve relative links in this dashboard
        assetBase
      };
    })();
  </script>

  <!-- ‚ë° Capture ?user_id, ?name, ?role and persist (unchanged logic, kept at top) -->
  <script>
    (function () {
      const p = new URLSearchParams(location.search);
      const uid  = p.get("user_id");
      const name = p.get("name");
      const role = p.get("role");
      if (uid && name && role) {
        localStorage.setItem("user_id", uid);
        localStorage.setItem("name", name);
        localStorage.setItem("role", role);
      }
    })();
  </script>

<head>
  <meta charset="UTF-8" />
  <title>Stock Staff Training Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ‚ë¢ Removed external ../config.js; we now use the tiny inline CONFIG above -->
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f2f2f2;
      color: #333;
      padding: 20px;
    }
    header {
      background-color: #00796b;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .info-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    li.completed {
      text-decoration: line-through;
      color: gray;
    }
    .training-link {
      text-decoration: none;
      color: #00796b;
      font-weight: bold;
    }
    button.complete-btn {
      float: right;
      background-color: #388e3c;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    h3 { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; }
    th { background-color: #00796b; color: white; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .filters, .alerts, .achievements { margin-top: 30px; }
    select { padding: 5px; margin-right: 10px; }
    .badge {
      background: #ffc107;
      color: #fff;
      padding: 5px 10px;
      border-radius: 12px;
      margin-left: 10px;
    }
    #completionChart { max-width: 300px; margin: auto; }
    .error { color: #c62828; margin-top: 8px; }
  </style>
</head>
<body>
  <header>
    <h2>üì¶ Stock Staff Training Dashboard</h2>
    <p>Cybersecurity and safety trainings for stockroom & warehouse employees</p>
  </header>

  <main>
    <div class="info-box filters">
      <h3>üîç Filter</h3>
      <select id="departmentFilter" onchange="fetchData()">
        <option value="All">All Departments</option>
        <option value="Warehouse">Warehouse</option>
        <option value="Inventory">Inventory</option>
      </select>
      <select id="riskFilter" onchange="fetchData()">
        <option value="All">All Risk Tiers</option>
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
      </select>
      <select id="timeFilter" onchange="fetchData()">
        <option value="All">All Time</option>
        <option value="7">Last 7 Days</option>
        <option value="30">Last 30 Days</option>
      </select>
      <div id="fetchError" class="error" style="display:none;"></div>
    </div>

    <div class="info-box" id="trainingSection">
      <h3>üìö Trainings</h3>
      <ul id="trainingList"></ul>
    </div>

    <div class="info-box">
      <h3>üìà Training Completion Overview</h3>
      <canvas id="completionChart"></canvas>
    </div>

    <div class="info-box">
      <h3>üèÜ Leaderboard</h3>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Completed Trainings</th>
            <th>Points</th>
            <th>Badges</th>
          </tr>
        </thead>
        <tbody id="leaderboard"></tbody>
      </table>
    </div>

    <div class="info-box alerts">
      <h3>üö® Alerts & Nudges</h3>
      <ul id="alertList"></ul>
    </div>

    <div class="info-box achievements">
      <h3>üéñÔ∏è Achievement Logs</h3>
      <ul>
        <li>Alex earned ‚ÄúDevice Guardian‚Äù for properly securing all inventory tablets.</li>
        <li>Nina earned ‚ÄúIncident Spotter‚Äù for timely reporting of unusual activity.</li>
      </ul>
    </div>
  </main>

  <script>
    // ‚ë£ Helper: build URLs that work from nested folders
    function url(href) {
      return new URL(href, window.CONFIG.assetBase).toString();
    }

    // ‚ë§ Training links now resolve via CONFIG.assetBase
    const trainingItems = [
      { title: "Secure Use of Inventory Devices", url: url("stock-staff-cybersecurity-training.html") },
      { title: "Incident Reporting for Warehouse Staff", url: url("stock-staff-incident-reporting-training.html") }
    ];

    const trainingListEl = document.getElementById('trainingList');
    const completedKey = 'completedTrainingsStock';
    const completedLocal = JSON.parse(localStorage.getItem(completedKey) || '[]');

    trainingItems.forEach(item => {
      const li = document.createElement('li');
      const link = document.createElement('a');
      const btn = document.createElement('button');

      link.href = item.url;
      link.innerText = item.title;
      link.className = 'training-link';
      link.target = '_blank';

      const already = completedLocal.includes(item.title);
      btn.innerText = already ? "‚úì Completed" : "Mark as Done";
      btn.className = 'complete-btn';

      if (already) {
        li.classList.add('completed');
        btn.style.backgroundColor = '#6c757d';
      }

      btn.onclick = () => {
        if (!completedLocal.includes(item.title)) {
          completedLocal.push(item.title);
          localStorage.setItem(completedKey, JSON.stringify(completedLocal));
          li.classList.add('completed');
          btn.innerText = "‚úì Completed";
          btn.style.backgroundColor = '#6c757d';
        }
      };

      li.appendChild(link);
      li.appendChild(btn);
      trainingListEl.appendChild(li);
    });

    // ‚ë• Reusable Chart.js instance (avoid duplicates on filter changes)
    let completionChartInstance = null;

    async function fetchData() {
      const err = document.getElementById('fetchError');
      err.style.display = 'none';
      err.textContent = '';

      try {
        const res = await fetch(window.CONFIG.SHEETDB_API, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        updateDashboard(data);
      } catch (e) {
        err.textContent = "Could not load data. Please try again.";
        err.style.display = 'block';
        // Clear sections on error so UI doesn't show stale data
        document.getElementById("leaderboard").innerHTML = "";
        document.getElementById("alertList").innerHTML = "";
        if (completionChartInstance) {
          completionChartInstance.destroy();
          completionChartInstance = null;
        }
      }
    }

    function updateDashboard(data) {
      const dept = document.getElementById("departmentFilter").value;
      const risk = document.getElementById("riskFilter").value;
      const days = document.getElementById("timeFilter").value;

      const now = new Date();
      const leaderboard = document.getElementById("leaderboard");
      const alerts = document.getElementById("alertList");
      leaderboard.innerHTML = "";
      alerts.innerHTML = "";

      // ‚ë¶ Defensive: tolerate different column names by normalizing
      const filtered = data.filter(row => {
        const Department = row.Department || row.department || row.Dept || "";
        const RiskTier   = row.RiskTier   || row.risk || row.Risk || "";
        const DateStr    = row.Date       || row.date || row.Timestamp || row.timestamp || "";
        const matchDept = dept === "All" || Department === dept;
        const matchRisk = risk === "All" || RiskTier === risk;
        const matchTime = days === "All" || (now - new Date(DateStr)) / (1000 * 60 * 60 * 24) <= parseInt(days, 10);
        return matchDept && matchRisk && matchTime;
      });

      const users = {};
      let completedCount = 0;
      filtered.forEach(row => {
        const Name          = row.Name || row.Employee || row.User || "Unknown";
        const Status        = row.Status || row.status || "";
        const Score         = parseInt(row.Score || row.score || "0", 10) || 0;
        const TrainingTitle = row.TrainingTitle || row.Training || row.training || "Training";

        if (!users[Name]) users[Name] = { count: 0, points: 0 };

        if (Status === "Complete") {
          users[Name].count++;
          users[Name].points += Score;
          completedCount++;
        }

        if (Status === "Incomplete") {
          alerts.insertAdjacentHTML("beforeend",
            `<li>${Name} missed ${TrainingTitle}. Retraining scheduled.</li>`);
        } else if (Score < 60) {
          alerts.insertAdjacentHTML("beforeend",
            `<li>${Name} scored low on ${TrainingTitle}. Nudge sent using GPT-4: "Would you like a refresher?"</li>`);
        }
      });

      Object.entries(users).forEach(([name, { count, points }]) => {
        const badge = points >= 150 ? "Gold" : points >= 100 ? "Silver" : "Bronze";
        leaderboard.insertAdjacentHTML(
          "beforeend",
          `<tr><td>${name}</td><td>${count}</td><td>${points}</td><td><span class='badge'>${badge}</span></td></tr>`
        );
      });

      // ‚ëß Recreate chart safely
      const ctx = document.getElementById('completionChart').getContext('2d');
      if (completionChartInstance) completionChartInstance.destroy();
      completionChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Completed', 'Incomplete'],
          datasets: [{
            data: [completedCount, Math.max(filtered.length - completedCount, 0)],
            backgroundColor: ['#388e3c', '#c62828']
          }]
        },
        options: { responsive: true }
      });
    }

    // First load
    fetchData();
  </script>
</body>
</html>
